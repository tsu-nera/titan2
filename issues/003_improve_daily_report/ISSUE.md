# Issue 003: デイリーレポートの改善

## 目的
集中瞑想におけるデイリーレポートを、脳波解析の専門的観点から改善し、実用的なフィードバックツールへと進化させる。

## 現状の問題点

### 1. 集中瞑想に特化した指標が不足
- リラックス度(α/β)、集中度(β/θ)、瞑想深度(θ/α)の3指標のみ
- 閾値が不適切（例: リラックス度17.075を「とても高い」と評価）
- 集中瞑想における「心の安定性」「注意の持続力」を測る指標がない

### 2. 時間セグメント分析の欠如
- セッション全体の平均値のみで、時間経過による変化が数値化されていない
- 「いつ集中が深まったか」「いつ心が散漫になったか」が分からない

### 3. 実用的なフィードバックの不足
- 数値は表示されているが「次回どうすべきか」の具体的アドバイスがない
- 「とても高い」「浅い」などの評価が定性的で改善につながらない

### 4. データ品質指標の改善が必要
- 有効データ率94.2%だが、どの時間帯で信号が悪かったか不明
- アーチファクト（筋電図混入、体動）の検出が不十分

### 5. 可視化が分かりにくい
- グラフが多すぎて「結局どうだったのか」が分かりにくい
- 集中瞑想に重要な指標が埋もれている

### 6. 統計的検定の欠如
- 前半と後半で統計的に有意な差があるか不明
- 日々の変動が偶然か実力の向上かを判断できない

---

## 改善計画

### Phase 1: コア機能の追加（優先度：高）

#### 1.1 Frontal Midline Theta (Fmθ) 分析 ✅（2025-10-31完了）
**目的**: 集中瞑想で最も重要な指標を追加

**実装内容**:
- AF7/AF8チャネルをMNE-Pythonで6-7Hzにバンドパスし、Hilbert包絡からFmθパワーを算出
- Fmθの時間推移をプロット（英語ラベルで出力）
- セッション平均、中央値、標準偏差、前半・後半平均および増加率を算出
- レポートに新セクションを追加し統計値・グラフを掲載

**成果物**:
- `lib/sensors/eeg/frontal_theta.py`: `calculate_frontal_theta()`, `plot_frontal_theta()`
- `lib/sensors/eeg/__init__.py`, `lib/__init__.py`: Fmθ APIの公開
- `issues/003_improve_daily_report/generate_report.py`: Fmθ解析の組み込み
- `issues/003_improve_daily_report/REPORT.md`: 「Frontal Midline Theta分析」セクションを追加し最新グラフを反映

#### 1.2 時間セグメント分析 ✅（2025-11-01完了）
**目的**: セッション中の集中度の変化を可視化

**実装内容**:
- セッションを5分刻みでセグメント分割
- 各セグメントで主要指標（Fmθ、IAF、Alpha、Beta、θ/α比）を計算
- ウォームアップ期間除外機能（1分間）の実装でアーティファクト対策
- Fmθセグメント平均計算時の外れ値除去（Z-score > 3）
- 対数値（Bels単位）での正しい計算ロジック実装：
  - θ/α比 = log(θ) - log(α)（引き算で計算）
  - Alpha/Beta/Thetaの表示単位を「Bels」に修正
- セグメント別の統計表を生成（正規化スコアで可視化）
- ピークパフォーマンス時間帯を特定（Fmθ、IAF、θ/α比の総合評価）

**成果物**:
- `lib/eeg.py`: `calculate_segment_analysis()` 関数（`warmup_minutes`パラメータ追加）
- `lib/sensors/eeg/plotting.py`: `plot_segment_comparison()` 関数
- `issues/003_improve_daily_report/generate_report.py`: セグメント分析の組み込み（warmup_minutes=1.0設定）
- `issues/003_improve_daily_report/REPORT.md`: 「時間経過分析」セクションを追加し最新グラフを反映

#### 1.3 総合スコアの算出
**目的**: 複数指標を統合した分かりやすい評価

**実装内容**:
- 以下の指標を0-100点で正規化して統合:
  - Fmθパワー (30%)
  - Alpha安定性 (20%)
  - 集中持続力 (20%)
  - β/α比率の低さ (15%)
  - データ品質 (15%)
- 総合スコアの算出ロジック
- 評価レベル（優秀/良好/普通/要改善）の判定

**成果物**:
- `lib/eeg.py`: `calculate_meditation_score()` 関数
- レポートの冒頭に「エグゼクティブサマリー」セクション

### Phase 2: 可視化とフィードバックの改善（優先度：中）

#### 2.1 サマリーダッシュボード
**目的**: 1枚の画像で全体像を把握

**実装内容**:
- 2x3グリッドのダッシュボード画像
  - 総合スコアゲージ
  - 時間セグメント別集中度
  - Fmθ時系列
  - Alpha安定性
  - 主要指標レーダーチャート
  - データ品質マップ

**成果物**:
- `lib/eeg.py`: `plot_summary_dashboard()` 関数
- レポートのトップに配置

#### 2.2 過去データとの比較機能
**目的**: 進捗の可視化

**実装内容**:
- 過去のレポートから総合スコアを抽出
- 前日比、週平均比、ベストスコアとの比較
- トレンドグラフ（過去7日/30日）
- 移動平均による長期トレンド

**成果物**:
- `lib/eeg.py`: `load_historical_scores()` 関数
- `lib/eeg.py`: `plot_score_trends()` 関数
- レポートに「過去データとの比較」セクション

#### 2.3 アクションアドバイス生成
**目的**: 具体的な改善提案

**実装内容**:
- ルールベースのアドバイスシステム:
  - Fmθが低い → 「呼吸への注意を強化」
  - Alpha変動大 → 「より静かな環境で実践」
  - β/α比高い → 「リラックスを意識」
  - 後半の集中度低下 → 「セッション時間の短縮を検討」

**成果物**:
- `lib/eeg.py`: `generate_meditation_advice()` 関数
- レポートに「アクションアドバイス」セクション

### Phase 3: 高度な分析機能（優先度：低）

#### 3.1 統計的検定
**目的**: 変化の有意性を検証

**実装内容**:
- 前半・後半比較（paired t-test）
- 複数日のトレンド分析（線形回帰）
- 異常セッション検出（Zスコア）

**成果物**:
- `lib/eeg.py`: `perform_statistical_tests()` 関数
- レポートに統計的有意性の表示

#### 3.2 データ品質の詳細分析
**目的**: ノイズ源の特定

**実装内容**:
- 時間帯別信号品質マップ
- チャネル別接触品質評価
- アーチファクト自動検出（筋電図、体動、瞬目）

**成果物**:
- `lib/eeg.py`: `analyze_signal_quality()` 関数
- `lib/eeg.py`: `detect_artifacts()` 関数
- レポートの「データ品質」セクションを拡充

#### 3.3 左右半球バランス分析
**目的**: 脳の活動バランスを評価

**実装内容**:
- 左右Alpha非対称性（FAA: Frontal Alpha Asymmetry）
- 半球別パワー比較
- 非対称性指数の時間推移

**成果物**:
- `lib/eeg.py`: `calculate_hemispheric_asymmetry()` 関数
- レポートに「左右半球バランス」セクション

---

## 新しいレポート構成

```
# Muse脳波データ分析レポート（改善版）

## エグゼクティブサマリー 【NEW】
- 総合スコア: 78/100 (前日比+5)
- セッション評価: 良好
- 主要指標スナップショット
- サマリーダッシュボード画像

## 1. データ概要
【既存のまま】

## 2. 時間セグメント分析 【NEW】
- 5分毎のセグメント統計表
- 集中度スコアの時系列グラフ
- ピークパフォーマンス時間帯

## 3. 集中瞑想コア指標 【NEW/改善】
### 3.1 Frontal Midline Theta (Fmθ)
- Fmθパワーの時間推移
- 統計サマリー
- 前半・後半比較

### 3.2 Alpha安定性
- Alphaパワーの変動係数
- 安定性スコア

### 3.3 集中持続力指標
- β/α比率の時間推移
- 注意の持続性評価

## 4. 周波数バンド統計
【既存のまま - 簡略化】

## 5. 詳細周波数解析
【既存のPSD、スペクトログラム、PAFを統合】

## 6. データ品質レポート 【改善】
- 全体品質評価
- 時間帯別品質マップ
- チャネル別評価

## 7. 過去データとの比較 【NEW】
- 前日比・週平均比
- トレンドグラフ

## 8. アクションアドバイス 【NEW】
- 今回の強み
- 改善ポイント
- 次回への具体的提案

## 9. まとめ
【既存を簡潔に】
```

---

## 実装順序

### Sprint 1（Week 1）
1. Fmθ分析機能の実装
2. 時間セグメント分析の実装
3. 総合スコア算出ロジックの実装

### Sprint 2（Week 2）
4. サマリーダッシュボードの実装
5. エグゼクティブサマリーセクションの追加
6. 既存レポート構成の整理

### Sprint 3（Week 3）
7. 過去データ比較機能の実装
8. アクションアドバイス生成の実装
9. ドキュメント整備

### Sprint 4（Week 4）
10. 統計的検定の実装
11. データ品質詳細分析の実装
12. 最終テストとリファクタリング

---

## 成功基準

1. **ユーザビリティ**: レポートを見て5秒以内にセッションの良し悪しが分かる
2. **実用性**: 具体的な改善アクションが提案されている
3. **正確性**: 脳波解析の学術的根拠に基づいた指標と閾値
4. **継続性**: 過去データとの比較で進捗が可視化されている
5. **完全性**: データ品質の問題が明確に報告されている

---

## 参考文献・根拠

- Frontal Midline Theta: Meditation研究における標準指標
- Alpha安定性: 注意の持続力を示す指標
- β/α比率: 緊張度・リラックス度の指標
- セグメント分析: 時間経過分析の標準手法
- 統計的検定: 科学的根拠のある評価手法

---

## 備考

- 既存の`lib/eeg.py`を拡張する形で実装
- 後方互換性を維持（issue 001, 002が動作し続ける）
- テストケースの追加
- ドキュメントの更新
