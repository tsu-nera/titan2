name: EEG Analysis

on:
  workflow_dispatch:
    inputs:
      date:
        description: '分析する日付（例: 2025-11-04）省略時は最新ファイル'
        required: false
        default: 'latest'
        type: string

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # 最大30分（通常5-10分）

    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: Python環境セットアップ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: 依存関係インストール
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Google Drive認証情報を設定
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          mkdir -p /tmp/credentials
          echo "$GDRIVE_CREDENTIALS" > /tmp/credentials/gdrive.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/credentials/gdrive.json" >> $GITHUB_ENV

      - name: Google DriveからCSVファイルを取得
        env:
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          # 一時ディレクトリ作成
          mkdir -p /tmp/data

          # CSVファイルをダウンロード
          if [ "${{ github.event.inputs.date }}" = "latest" ]; then
            echo "最新ファイルをダウンロード中..."
            python scripts/fetch_from_gdrive.py \
              --folder-id "$FOLDER_ID" \
              --download latest \
              --output /tmp/data
          else
            echo "日付指定でダウンロード中: ${{ github.event.inputs.date }}"
            python scripts/fetch_from_gdrive.py \
              --folder-id "$FOLDER_ID" \
              --download "${{ github.event.inputs.date }}" \
              --output /tmp/data
          fi

          # ダウンロードしたCSVファイルのパスを環境変数に保存
          CSV_FILE=$(ls /tmp/data/*.csv | head -n 1)
          echo "CSV_PATH=$CSV_FILE" >> $GITHUB_ENV
          echo "ダウンロード完了: $CSV_FILE"

      - name: 脳波分析を実行
        run: |
          # タイムスタンプ生成
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_DIR="/tmp/eeg_reports/${TIMESTAMP}"

          echo "分析開始..."
          echo "  入力CSV: $CSV_PATH"
          echo "  出力先: $OUTPUT_DIR"

          # レポート生成
          python issues/003_improve_daily_report/generate_report.py \
            --data "$CSV_PATH" \
            --output "$OUTPUT_DIR"

          # 環境変数に保存
          CSV_NAME=$(basename "$CSV_PATH")
          COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')

          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "CSV_NAME=$CSV_NAME" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "分析完了: $OUTPUT_DIR"

      - name: GitHub Issueにレポートを投稿
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPORT_MD="${OUTPUT_DIR}/REPORT.md"

          # 画像参照を削除したテキスト版レポートを作成
          grep -v "!\[.*\](img/" "$REPORT_MD" > /tmp/report_text.md

          # セッション情報ヘッダーを作成
          echo "## 📊 脳波分析レポート" > /tmp/issue_header.md
          echo "" >> /tmp/issue_header.md
          echo "- 計測日時: ${COMMIT_DATE}" >> /tmp/issue_header.md
          echo "- 入力CSV: ${CSV_NAME}" >> /tmp/issue_header.md
          echo "- ワークフロー実行: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> /tmp/issue_header.md
          echo "" >> /tmp/issue_header.md
          echo "---" >> /tmp/issue_header.md
          echo "" >> /tmp/issue_header.md

          # ヘッダーとレポートを結合
          cat /tmp/issue_header.md /tmp/report_text.md > /tmp/final_issue.md

          # Issue作成
          ISSUE_URL=$(gh issue create \
            --repo "${{ github.repository }}" \
            --title "[EEG Report] ${COMMIT_DATE}" \
            --body-file /tmp/final_issue.md)

          echo "✅ Issue作成完了: ${ISSUE_URL}"

          # Issue番号を抽出
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oP '/issues/\K\d+')
          echo "Issue番号: #${ISSUE_NUMBER}"

          # 画像を1枚ずつコメントで添付
          echo "画像をアップロード中..."
          for img in "${OUTPUT_DIR}"/img/*.png; do
            if [ -f "$img" ]; then
              IMG_NAME=$(basename "$img")
              echo "  アップロード: ${IMG_NAME}"

              # GitHub APIで画像をアップロード
              UPLOAD_RESPONSE=$(curl -s -X POST \
                -H "Authorization: token $GH_TOKEN" \
                -H "Content-Type: image/png" \
                -H "Accept: application/vnd.github+json" \
                --data-binary "@${img}" \
                "https://uploads.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/assets?name=${IMG_NAME}")

              # アップロードされた画像URLを取得
              IMG_URL=$(echo "$UPLOAD_RESPONSE" | jq -r '.browser_download_url // .url // empty')

              if [ -n "$IMG_URL" ]; then
                # コメントで画像を追加
                gh issue comment "${ISSUE_URL}" --body "![${IMG_NAME}](${IMG_URL})" 2>/dev/null || \
                gh issue comment "${ISSUE_URL}" --body "**${IMG_NAME}**"
              fi
            fi
          done

          echo "ISSUE_URL=${ISSUE_URL}" >> $GITHUB_ENV
          echo "✅ 画像アップロード完了"

      - name: クリーンアップ
        if: always()
        run: |
          # 一時ファイル削除
          rm -rf /tmp/data
          rm -rf /tmp/credentials
          rm -rf /tmp/eeg_reports

      - name: 分析結果サマリー
        if: success()
        run: |
          echo "✅ 脳波分析が完了しました"
          echo ""
          echo "📊 GitHub Issueでレポートを閲覧:"
          echo "   ${ISSUE_URL}"
          echo ""
          echo "💡 スマホからGitHub Mobileアプリで閲覧できます"
          echo "   Issues → eeg-report ラベル"
