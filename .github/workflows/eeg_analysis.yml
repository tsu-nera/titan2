name: EEG Analysis

on:
  workflow_dispatch:
    inputs:
      date:
        description: 'åˆ†æã™ã‚‹æ—¥ä»˜ï¼ˆä¾‹: 2025-11-04ï¼‰çœç•¥æ™‚ã¯æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«'
        required: false
        default: 'latest'
        type: string

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # æœ€å¤§30åˆ†ï¼ˆé€šå¸¸5-10åˆ†ï¼‰
    permissions:
      contents: write
    env:
      TZ: Asia/Tokyo

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Google Driveèªè¨¼æƒ…å ±ã‚’è¨­å®š
        env:
          GDRIVE_CREDENTIALS: ${{ secrets.GDRIVE_CREDENTIALS }}
        run: |
          mkdir -p /tmp/credentials
          echo "$GDRIVE_CREDENTIALS" > /tmp/credentials/gdrive.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/credentials/gdrive.json" >> $GITHUB_ENV

      - name: Google Driveã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        env:
          FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          # ä¸€æ™‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
          mkdir -p /tmp/data

          # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if [ "${{ github.event.inputs.date }}" = "latest" ]; then
            echo "æœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­..."
            python scripts/fetch_from_gdrive.py \
              --folder-id "$FOLDER_ID" \
              --download latest \
              --output /tmp/data
          else
            echo "æ—¥ä»˜æŒ‡å®šã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­: ${{ github.event.inputs.date }}"
            python scripts/fetch_from_gdrive.py \
              --folder-id "$FOLDER_ID" \
              --download "${{ github.event.inputs.date }}" \
              --output /tmp/data
          fi

          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          CSV_FILE=$(ls /tmp/data/*.csv | head -n 1)
          echo "CSV_PATH=$CSV_FILE" >> $GITHUB_ENV
          echo "ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†: $CSV_FILE"

      - name: è„³æ³¢åˆ†æã‚’å®Ÿè¡Œ
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          OUTPUT_DIR="/tmp/eeg_reports/${TIMESTAMP}"

          echo "åˆ†æé–‹å§‹..."
          echo "  å…¥åŠ›CSV: $CSV_PATH"
          echo "  å‡ºåŠ›å…ˆ: $OUTPUT_DIR"

          # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          python scripts/generate_report.py \
            --data "$CSV_PATH" \
            --output "$OUTPUT_DIR"

          # ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          CSV_NAME=$(basename "$CSV_PATH")
          COMMIT_DATE=$(date +'%Y-%m-%d %H:%M:%S')

          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          echo "CSV_NAME=$CSV_NAME" >> $GITHUB_ENV
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_ENV
          echo "åˆ†æå®Œäº†: $OUTPUT_DIR"

      - name: GitHub Releaseã‚’ä½œæˆã—ã¦ãƒ¬ãƒãƒ¼ãƒˆã¨ç”»åƒã‚’å…¬é–‹
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPORT_MD="${OUTPUT_DIR}/REPORT.md"

          # ã‚¿ã‚°åã¨ãƒªãƒªãƒ¼ã‚¹åã‚’ç”Ÿæˆ
          TAG_NAME="eeg-report-$(date +%Y%m%d_%H%M%S)"
          RELEASE_TITLE="EEG Analysis Report - ${COMMIT_DATE}"

          echo "Releaseã‚’ä½œæˆä¸­..."
          echo "  ã‚¿ã‚°: ${TAG_NAME}"
          echo "  ã‚¿ã‚¤ãƒˆãƒ«: ${RELEASE_TITLE}"

          # ç”»åƒãƒ‘ã‚¹ã‚’Releaseã®URLã«ç½®æ›ï¼ˆå…ƒã®é †åºã‚’ä¿æŒï¼‰
          sed "s|img/\([^)]*\.png\)|https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/\1|g" \
            "$REPORT_MD" > /tmp/report_with_images.md

          # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œãƒªãƒ³ã‚¯ã‚’ãƒ¬ãƒãƒ¼ãƒˆå†’é ­ã«è¿½åŠ 
          echo "> **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" > /tmp/release_notes.md
          echo "" >> /tmp/release_notes.md
          cat /tmp/report_with_images.md >> /tmp/release_notes.md

          # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
          IMG_FILES=$(ls "${OUTPUT_DIR}"/img/*.png 2>/dev/null || echo "")

          if [ -z "$IMG_FILES" ]; then
            echo "âš ï¸  ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

          # Releaseã‚’ä½œæˆã—ã¦ç”»åƒã¨ãƒ¬ãƒãƒ¼ãƒˆã‚’æ·»ä»˜
          RELEASE_URL=$(gh release create "${TAG_NAME}" \
            --repo "${{ github.repository }}" \
            --title "${RELEASE_TITLE}" \
            --notes-file /tmp/release_notes.md \
            ${IMG_FILES})

          echo "âœ… Releaseä½œæˆå®Œäº†: ${RELEASE_URL}"
          echo "RELEASE_URL=${RELEASE_URL}" >> $GITHUB_ENV

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
          rm -rf /tmp/data
          rm -rf /tmp/credentials
          rm -rf /tmp/eeg_reports

      - name: åˆ†æçµæœã‚µãƒãƒªãƒ¼
        if: success()
        run: |
          echo "âœ… è„³æ³¢åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo ""
          echo "ğŸ“Š GitHub Releaseã§ãƒ¬ãƒãƒ¼ãƒˆã‚’é–²è¦§:"
          echo "   ${RELEASE_URL}"
          echo ""
          echo "ğŸ’¡ ã‚¹ãƒãƒ›ã‹ã‚‰GitHub Mobileã‚¢ãƒ—ãƒªã§é–²è¦§ã§ãã¾ã™"
          echo "   Releases â†’ æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹"
